<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, viewport-fit=cover">
    <title>$100 QuickGiveaway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ad SDK Script -->
    <script src='//libtl.com/sdk.js' data-zone='9980483' data-sdk='show_9980483'></script>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ... (your existing CSS unchanged) ... */
    </style>
</head>
<body>
    <!-- ... (your existing HTML unchanged) ... -->

    <script>
    // App State
    const appState = {
        adsWatched: 0,
        linksWatched: 0,
        isParticipating: false,
        balance: 0,
        userName: 'Telegram User',
        userPic: 'https://picsum.photos/seed/telegramuser/60/60.jpg',
        userId: null,
        withdrawalHistory: [],
        currentWinner: ' Nikhil kumar',
        winnerDate: 'Today',
        previousWinners: [
            { name: 'Rajesh Kumar', date: 'Last 24h' },
            { name: 'Amit Patel', date: 'Previous 24h' },
            { name: 'Sneha Reddy', date: '2 cycles ago' },
            { name: 'Vikram Singh', date: '3 cycles ago' }
        ],
        adLoading: false,
        linkLoading: false,
        lastSavedDate: null, // Will be set to UTC date string
        clickedLinks: new Set()
    };

    const viralLinks = [
        // ... (unchanged)
    ];

    const indianPakistaniNames = [
        // ... (unchanged)
    ];

    // Helper: Get UTC date string (e.g., "Mon Apr 08 2024")
    function getUTCDateString() {
        const now = new Date();
        return new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())).toDateString();
    }

    // Local Storage Functions
    function saveUserState() {
        if (!appState.userId) return;
        try {
            const stateToSave = {
                adsWatched: appState.adsWatched,
                linksWatched: appState.linksWatched,
                isParticipating: appState.isParticipating,
                balance: appState.balance,
                withdrawalHistory: appState.withdrawalHistory,
                currentWinner: appState.currentWinner,
                winnerDate: appState.winnerDate,
                previousWinners: appState.previousWinners,
                lastSavedDate: appState.lastSavedDate,
                clickedLinks: Array.from(appState.clickedLinks)
            };
            localStorage.setItem(`user_${appState.userId}`, JSON.stringify(stateToSave));
        } catch (e) {
            console.error("Local storage save error:", e);
        }
    }

    function loadUserState() {
        const todayUTC = getUTCDateString();
        if (!appState.userId) {
            resetAppState();
            return;
        }
        try {
            const savedState = localStorage.getItem(`user_${appState.userId}`);
            if (savedState) {
                const data = JSON.parse(savedState);
                appState.adsWatched = data.adsWatched || 0;
                appState.linksWatched = data.linksWatched || 0;
                appState.isParticipating = data.isParticipating || false;
                appState.balance = data.balance || 0;
                appState.withdrawalHistory = data.withdrawalHistory || [];
                appState.currentWinner = data.currentWinner || ' Nikhil kumar';
                appState.winnerDate = data.winnerDate || 'Today';
                appState.previousWinners = data.previousWinners || [...appState.previousWinners];
                appState.lastSavedDate = data.lastSavedDate || todayUTC;
                appState.clickedLinks = new Set(data.clickedLinks || []);
            } else {
                resetAppState();
            }
        } catch (e) {
            console.error("Local storage load error:", e);
            resetAppState();
        }
    }

    function resetAppState() {
        appState.adsWatched = 0;
        appState.linksWatched = 0;
        appState.isParticipating = false;
        appState.clickedLinks = new Set();
        appState.lastSavedDate = getUTCDateString();
    }

    // Telegram Init (unchanged)
    function initTelegramApp() {
        if (window.Telegram?.WebApp) {
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.enableClosingConfirmation();
            let user = window.Telegram.WebApp.initDataUnsafe?.user;
            if (!user && window.Telegram.WebApp.initData) {
                try {
                    const params = new URLSearchParams(window.Telegram.WebApp.initData);
                    const userStr = params.get('user');
                    if (userStr) user = JSON.parse(decodeURIComponent(userStr));
                } catch (e) {
                    console.error('Parse error:', e);
                }
            }
            if (user) {
                appState.userName = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '');
                appState.userId = user.id;
                appState.userPic = user.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
                document.getElementById('userName').textContent = appState.userName;
                document.getElementById('userProfilePic').src = appState.userPic;
            }
        } else {
            document.getElementById('userName').textContent = 'Test User';
            showNotification('‚ö†Ô∏è Running in test mode');
        }
    }

    // Countdown & Winner Logic
    function getNextGiveawayEndTime() {
        const now = new Date();
        const next = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1, 0, 0, 0));
        return next.getTime();
    }

    function updateCountdown() {
        const now = Date.now();
        const giveawayEndTime = getNextGiveawayEndTime();
        const distance = giveawayEndTime - now;
        if (distance <= 0) {
            selectWinner();
            return;
        }
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        document.getElementById('homeCountdown').textContent = `${hours}h ${minutes}m ${seconds}s`;
    }

    function startCountdown() {
        updateCountdown();
        setInterval(updateCountdown, 1000);
    }

    function selectWinner() {
        // Move current winner to past list
        appState.previousWinners.unshift({
            name: appState.currentWinner.trim(),
            date: appState.winnerDate
        });
        appState.previousWinners = appState.previousWinners.slice(0, 4);

        // Pick new winner
        appState.currentWinner = indianPakistaniNames[Math.floor(Math.random() * indianPakistaniNames.length)];
        appState.winnerDate = 'Today';

        // Reward user if they participated
        if (appState.isParticipating && Math.random() < 0.1) {
            appState.balance += 100;
            updateBalanceDisplay();
            showNotification('üéä You won $100!');
            createConfetti();
        }

        // Reset for next cycle
        appState.isParticipating = false;
        appState.adsWatched = 0;
        appState.linksWatched = 0;
        appState.clickedLinks = new Set();
        appState.lastSavedDate = getUTCDateString(); // Critical: update saved date

        // Update UI
        updateAdProgress();
        updateLinkProgress();
        updateEnterProgress();
        updateWinnersDisplay();
        saveUserState();
    }

    // NEW: Check if giveaway period expired and reset if needed
    function checkAndResetIfExpired() {
        const now = Date.now();
        const giveawayEndTime = getNextGiveawayEndTime();
        const todayUTC = getUTCDateString();

        // If timer expired OR saved date is outdated ‚Üí trigger reset
        if (now >= giveawayEndTime || appState.lastSavedDate !== todayUTC) {
            selectWinner();
            showNotification('üåÖ Daily reset! New giveaway started!');
        }
    }

    // UI Helpers (unchanged except minor cleanup)
    function updateAdProgress() {
        const pct = (appState.adsWatched / 100) * 100;
        document.getElementById('adProgress').style.width = `${pct}%`;
        document.getElementById('adProgressText').textContent = `${appState.adsWatched}/100`;
        document.getElementById('adsWatchedCount').textContent = appState.adsWatched;
        document.getElementById('watchAdBtn').innerHTML = `<i class="fas fa-play mr-2"></i> Watch Ad`;
    }

    function updateLinkProgress() {
        const pct = (appState.linksWatched / viralLinks.length) * 100;
        document.getElementById('linkProgress').style.width = `${pct}%`;
        document.getElementById('linkProgressText').textContent = `${appState.linksWatched}/${viralLinks.length}`;
        document.getElementById('linksWatchedCount').textContent = appState.linksWatched;
        document.getElementById('watchLinkBtn').innerHTML = `<i class="fas fa-external-link-alt mr-2"></i> Watch Link`;
    }

    function updateEnterProgress() {
        const total = 100 + viralLinks.length;
        const completed = appState.adsWatched + appState.linksWatched;
        const pct = Math.round((completed / total) * 100);
        const fill = document.getElementById('enterProgressFill');
        const text = document.getElementById('enterProgressText');
        fill.style.width = `${pct}%`;
        if (completed >= total && !appState.isParticipating) {
            fill.classList.add('complete');
            text.innerHTML = '<i class="fas fa-rocket mr-2"></i> üéâ CLICK TO ENTER GIVEAWAY! üéâ';
        } else if (appState.isParticipating) {
            fill.classList.add('complete');
            text.innerHTML = '<i class="fas fa-check-circle mr-2"></i> You\'re in the giveaway! Good luck!';
        } else {
            fill.classList.remove('complete');
            text.innerHTML = `<i class="fas fa-rocket mr-2"></i> Enter Giveaway`;
        }
    }

    function updateWinnersDisplay() {
        document.getElementById('currentWinner').textContent = appState.currentWinner;
        document.getElementById('winnerDate').textContent = appState.winnerDate;
        const colors = ['from-yellow-400 to-orange-500', 'from-gray-400 to-gray-600', 'from-orange-600 to-red-600', 'from-blue-400 to-blue-600'];
        document.getElementById('previousWinners').innerHTML = appState.previousWinners.map((w, i) => `
            <div class="task-item">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-gradient-to-br ${colors[i]} rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-medal text-white"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">${w.name}</p>
                            <p class="text-xs text-gray-500">${w.date}</p>
                        </div>
                    </div>
                    <span class="text-green-600 font-bold">$100</span>
                </div>
            </div>
        `).join('');
    }

    function updateBalanceDisplay() {
        const bal = appState.balance.toFixed(2);
        document.getElementById('userBalance').textContent = bal;
        document.getElementById('withdrawBalance').textContent = bal;
        document.getElementById('requestWithdrawBtn').disabled = appState.balance < 10;
    }

    function updateWithdrawalHistory() {
        if (!appState.withdrawalHistory.length) {
            document.getElementById('withdrawalHistory').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <p>No transactions yet</p>
                </div>`;
            return;
        }
        document.getElementById('withdrawalHistory').innerHTML = appState.withdrawalHistory.map(w => `
            <div class="task-item">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold text-gray-800">$${w.amount.toFixed(2)}</p>
                        <p class="text-xs text-gray-500">${w.date}</p>
                        <p class="text-xs text-gray-400 mt-1">${w.address.substring(0,10)}...${w.address.slice(-10)}</p>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-bold ${
                        w.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'
                    }">${w.status === 'pending' ? '‚è≥ Pending' : '‚úÖ Completed'}</span>
                </div>
            </div>
        `).join('');
    }

    function showNotification(msg) {
        const el = document.getElementById('notification');
        document.getElementById('notificationText').textContent = msg;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 3000);
    }

    function showConfirmModal(msg, cb) {
        document.getElementById('confirmMessage').textContent = msg;
        const modal = document.getElementById('confirmModal');
        modal.classList.add('show');
        document.getElementById('confirmBtn').onclick = () => {
            modal.classList.remove('show');
            cb();
        };
    }

    function createConfetti() {
        const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#fa709a', '#fee140'];
        for (let i = 0; i < 100; i++) {
            setTimeout(() => {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + '%';
                c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 3000);
            }, i * 30);
        }
    }

    function showAd() {
        if (typeof show_9980483 !== 'function') {
            showNotification('‚ö†Ô∏è Ad service unavailable.');
            return;
        }
        if (appState.adLoading || appState.adsWatched >= 100) return;
        appState.adLoading = true;
        const btn = document.getElementById('watchAdBtn');
        const orig = btn.innerHTML;
        btn.innerHTML = '<span class="ad-loading"></span> Loading Ad...';
        btn.disabled = true;
        show_9980483().then(() => {
            appState.adsWatched++;
            updateAdProgress();
            updateEnterProgress();
            saveUserState();
            showNotification('üé¨ Ad watched! Keep going!');
        }).catch(err => {
            console.error('Ad error:', err);
            showNotification('‚ö†Ô∏è Ad failed. Try again.');
        }).finally(() => {
            appState.adLoading = false;
            btn.innerHTML = orig;
            btn.disabled = false;
        });
    }

    function watchLink() {
        if (appState.linkLoading || appState.linksWatched >= viralLinks.length) return;
        let nextLinkIndex = -1;
        for (let i = 0; i < viralLinks.length; i++) {
            if (!appState.clickedLinks.has(i)) {
                nextLinkIndex = i;
                break;
            }
        }
        if (nextLinkIndex === -1) return;
        appState.linkLoading = true;
        const btn = document.getElementById('watchLinkBtn');
        const orig = btn.innerHTML;
        btn.innerHTML = '<span class="ad-loading"></span> Opening Link...';
        btn.disabled = true;
        appState.clickedLinks.add(nextLinkIndex);
        appState.linksWatched++;
        window.open(viralLinks[nextLinkIndex], '_blank');
        updateLinkProgress();
        updateEnterProgress();
        saveUserState();
        showNotification(`üîó Link opened!`);
        setTimeout(() => {
            appState.linkLoading = false;
            btn.innerHTML = orig;
            btn.disabled = false;
        }, 1000);
    }

    // Initialize App
    async function initApp() {
        initTelegramApp();
        await loadUserState();
        checkAndResetIfExpired(); // ‚úÖ CRITICAL: ensures reset happens even if user missed timer
        updateAdProgress();
        updateLinkProgress();
        updateEnterProgress();
        updateBalanceDisplay();
        updateWinnersDisplay();
        updateWithdrawalHistory();
        startCountdown();

        // Event listeners (unchanged)
        document.getElementById('watchAdBtn').addEventListener('click', showAd);
        document.getElementById('watchLinkBtn').addEventListener('click', watchLink);
        document.getElementById('enterProgress').addEventListener('click', () => {
            const total = 100 + viralLinks.length;
            const completed = appState.adsWatched + appState.linksWatched;
            if (completed >= total && !appState.isParticipating) {
                showConfirmModal("üéä You're now participating in the $100 Giveaway! Good luck!", () => {
                    appState.isParticipating = true;
                    saveUserState();
                    createConfetti();
                    showNotification('üöÄ Successfully entered the giveaway!');
                    updateEnterProgress();
                });
            }
        });
        document.getElementById('requestWithdrawBtn').addEventListener('click', () => {
            const addr = document.getElementById('binanceAddress').value;
            if (!addr) return showNotification('‚ö†Ô∏è Enter Binance address');
            if (appState.balance < 10) return showNotification('‚ö†Ô∏è Minimum $10 required');
            showConfirmModal('üí∏ Withdrawal request received. Processed within 24 hours.', () => {
                appState.withdrawalHistory.unshift({
                    id: Date.now(),
                    amount: appState.balance,
                    address: addr,
                    date: new Date().toLocaleDateString(),
                    status: 'pending'
                });
                appState.balance = 0;
                updateBalanceDisplay();
                updateWithdrawalHistory();
                saveUserState();
                document.getElementById('binanceAddress').value = '';
                showNotification('‚úÖ Withdrawal submitted!');
            });
        });
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                document.querySelector('.container').scrollTop = 0;
            });
        });
    }

    document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
