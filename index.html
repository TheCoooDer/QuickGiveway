<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, viewport-fit=cover">
    <title>$100 QuickGiveaway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ad SDK Script - Updated -->
    <script src='//libtl.com/sdk.js' data-zone='10019074' data-sdk='show_10019074'></script>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * {
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --accent-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --accent-color: #f5576c;
            --success-color: #48bb78;
            --warning-color: #f6ad55;
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --tg-bg-primary: #667eea;
            --tg-bg-secondary: #764ba2;
        }
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }
        body {
            color: var(--text-primary);
            position: relative;
            overflow-x: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,138.7C960,139,1056,117,1152,106.7C1248,96,1344,96,1392,96L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
            pointer-events: none;
            z-index: 0;
        }
        .app-wrapper {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .container {
            position: relative;
            z-index: 1;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            padding-bottom: calc(80px + var(--safe-area-inset-bottom));
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        .glass-card,
        .enter-progress,
        .bottom-nav > .glass-card {
            max-width: 100%;
        }
        .grid.grid-cols-1.md\:grid-cols-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 500px) {
            .grid.grid-cols-1.md\:grid-cols-2 {
                grid-template-columns: 1fr 1fr;
            }
        }
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn {
            border-radius: 12px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        .btn-accent {
            background: var(--accent-gradient);
            color: white;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-accent:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(245, 87, 108, 0.4);
        }
        .btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .progress-bar {
            height: 28px;
            border-radius: 14px;
            background: #e2e8f0;
            overflow: hidden;
            position: relative;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .countdown {
            font-size: 1.8rem;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .winner-card {
            background: var(--accent-gradient);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(245, 87, 108, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .winner-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .social-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 16px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .social-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        .social-card i {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 999;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 32px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .tab-button {
            flex: 1;
            padding: 8px 4px;
            text-align: center;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            color: #4a5568;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .tab-button i {
            font-size: 1.4rem;
            margin-bottom: 2px;
        }
        .tab-button span {
            font-size: 0.7rem;
            line-height: 1;
        }
        .tab-button.active {
            color: #667eea;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 3px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: var(--safe-area-inset-bottom);
        }
        .balance-display {
            background: var(--primary-gradient);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            position: absolute;
            animation: confetti-fall 3s linear forwards;
        }
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .shimmer-badge {
            background: var(--accent-gradient);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            animation: shimmer 2s infinite;
        }
        input[type="text"] {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 14px;
            width: 100%;
            transition: all 0.3s ease;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .task-item {
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        .floating-icon {
            position: absolute;
            opacity: 0.1;
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        .ad-loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .profile-loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }
        @supports (padding: max(0px)) {
            .container {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }
        }
        .container {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        .container::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        .container {
            scrollbar-width: none;
        }
        .link-progress {
            background: var(--secondary-gradient);
        }
        .enter-progress {
            height: 60px;
            border-radius: 20px;
            background: #e2e8f0;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .enter-progress:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        .enter-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            transition: width 0.6s ease;
            position: relative;
            overflow: hidden;
        }
        .enter-progress-fill.complete {
            background: var(--accent-gradient);
            animation: pulse 2s infinite;
        }
        .enter-progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }
        .enter-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            font-size: 16px;
            text-align: center;
            width: 100%;
            padding: 0 20px;
            z-index: 10;
            pointer-events: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .ad-status {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }
        .ad-error {
            color: #e53e3e;
            font-size: 12px;
            margin-top: 5px;
            text-align: center;
        }
        .winner-updating {
            animation: pulse 1s infinite;
        }
        @keyframes winnerUpdate {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCZfqwAg5pEtAgxeTscbfyFl5FN2tqw20I",
        authDomain: "quickgiveaway-280f2.firebaseapp.com",
        projectId: "quickgiveaway-280f2",
        storageBucket: "quickgiveaway-280f2.firebasestorage.app",
        messagingSenderId: "186237872533",
        appId: "1:186237872533:web:8f1ee575d93b78f0e6ae9c"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    </script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="app-wrapper">
        <div class="container">
            <i class="fas fa-gift floating-icon text-white text-6xl" style="top: 10%; left: 5%;"></i>
            <i class="fas fa-trophy floating-icon text-white text-4xl" style="top: 60%; right: 5%; animation-delay: 2s;"></i>
            <i class="fas fa-coins floating-icon text-white text-5xl" style="bottom: 20%; left: 10%; animation-delay: 4s;"></i>
            <header class="mb-6">
                <div class="glass-card p-5">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="relative">
                                <img id="userProfilePic" src="https://picsum.photos/seed/telegramuser/60/60.jpg" alt="Profile" class="w-14 h-14 rounded-full border-3 border-white shadow-lg">
                                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-400 rounded-full border-2 border-white"></div>
                            </div>
                            <div class="ml-4">
                                <h2 id="userName" class="font-bold text-xl text-gray-800">
                                    Loading...
                                    <span class="profile-loading"></span>
                                </h2>
                                <div class="flex items-center mt-1">
                                    <i class="fas fa-coins text-yellow-500 mr-1"></i>
                                    <span class="text-sm font-semibold text-gray-600">Balance: $<span id="userBalance">0.00</span></span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-gift text-white text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <div id="home" class="tab-content active">
                <div class="glass-card p-6 mb-6 text-center relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="shimmer-badge inline-block mb-3">ðŸŽ‰ LIVE GIVEAWAY</div>
                        <h1 class="text-3xl font-black mb-3 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                            $100 QuickGiveaway
                        </h1>
                        <p class="text-gray-600 mb-4">Every 24 hours â€¢ One winner</p>
                        <div class="pulse">
                            <div class="countdown text-4xl" id="homeCountdown">Loading...</div>
                        </div>
                    </div>
                    <i class="fas fa-gift absolute -right-10 -top-10 text-white opacity-10 text-9xl"></i>
                </div>
                <!-- Ad Card - Full Width -->
                <div class="glass-card p-6 mb-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-play-circle text-purple-600 mr-2"></i>
                            Watch Ads <span id="adsWatchedCount">0</span> / 100 
                        </h3>
                        <span class="shimmer-badge">Required</span>
                    </div>
                    <div class="progress-bar mb-4">
                        <div class="progress-fill" id="adProgress" style="width: 0%">
                            <span id="adProgressText">0/100</span>
                        </div>
                    </div>
                    <button id="watchAdBtn" class="btn btn-primary w-full">
                        <i class="fas fa-play mr-2"></i> Watch Ad 
                    </button>
                    <div id="adStatus" class="ad-status"></div>
                    <div id="adError" class="ad-error"></div>
                </div>
                <!-- Links Card - Full Width -->
                <div class="glass-card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-link text-pink-600 mr-2"></i>
                            Watch 18-link <span id="linksWatchedCount">0</span> / 19
                        </h3>
                        <span class="shimmer-badge">Required</span>
                    </div>
                    <div class="progress-bar mb-4">
                        <div class="progress-fill link-progress" id="linkProgress" style="width: 0%">
                            <span id="linkProgressText"> </span>
                        </div>
                    </div>
                    <button id="watchLinkBtn" class="btn btn-accent w-full">
                        <i class="fas fa-external-link-alt mr-2"></i> Watch Link 
                    </button>
                </div>
                <div class="enter-progress" id="enterProgress">
                    <div class="enter-progress-fill" id="enterProgressFill" style="width: 0%"></div>
                    <div class="enter-progress-text" id="enterProgressText">
                        <i class="fas fa-rocket mr-2"></i>
                        Enter Giveaway
                    </div>
                </div>
            </div>
            <div id="tasks" class="tab-content">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">
                        <i class="fas fa-clipboard-list text-purple-600 mr-2"></i>
                        Social Media Tasks
                    </h2>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <a href="https://t.me/EarnOnlineWithSufyan" target="_blank" class="social-card">
                            <i class="fab fa-telegram text-blue-500"></i>
                            <span class="text-sm font-bold text-gray-700"> Channel</span>
                        </a>
                        <a href="https://t.me/quick_cash_announcement" target="_blank" class="social-card">
                            <i class="fas fa-users text-blue-600"></i>
                            <span class="text-sm font-bold text-gray-700"> Group</span>
                        </a>
                        <a href="https://www.facebook.com/sufyanThePro" target="_blank" class="social-card">
                            <i class="fab fa-facebook text-blue-700"></i>
                            <span class="text-sm font-bold text-gray-700">Facebook</span>
                        </a>
                        <a href="https://www.youtube.com/@SufyanCircuit" target="_blank" class="social-card">
                            <i class="fab fa-youtube text-red-500"></i>
                            <span class="text-sm font-bold text-gray-700">YouTube</span>
                        </a>
                    </div>
                    <div class="text-center py-6">
                        <i class="fas fa-info-circle text-purple-600 text-3xl mb-3"></i>
                        <p class="text-gray-600 font-medium">Follow our social media channels to stay updated with the latest giveaways and announcements!</p>
                        <p class="text-sm text-gray-500 mt-2">Click on any card above to visit our social media pages</p>
                    </div>
                </div>
            </div>
            <div id="winners" class="tab-content">
                <div class="glass-card p-6">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-crown text-yellow-500 mr-2"></i>
                            Hall of Winners
                        </h2>
                    </div>
                    <div class="winner-card mb-6 relative">
                        <div class="relative z-10">
                            <i class="fas fa-trophy text-5xl text-white mb-3"></i>
                            <h3 class="text-xl font-bold text-white mb-2" id="winnerTitle">ðŸŽŠ Today's Winner ðŸŽŠ</h3>
                            <p class="text-3xl font-black text-white" id="currentWinner">Loading...</p>
                            <p class="text-white/90 mt-2" id="winnerDate">Today</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-4 text-gray-800">Previous Winner</h3>
                        <div class="task-item" id="previousWinner">
                            <!-- Previous winner will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div id="withdraw" class="tab-content">
                <div class="glass-card p-6">
                    <h2 class="text-2xl font-bold mb-6 text-gray-800">
                        <i class="fas fa-hand-holding-usd text-green-600 mr-2"></i>
                        Withdraw Funds
                    </h2>
                    <div class="balance-display mb-6">
                        <p class="text-white/90 text-sm mb-2">Available Balance</p>
                        <p class="balance-amount">$<span id="withdrawBalance">0.00</span></p>
                        <p class="text-white/80 text-xs mt-2">Minimum withdrawal: $10</p>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">
                            <i class="fas fa-wallet mr-1"></i> Binance Wallet Address
                        </label>
                        <input type="text" id="binanceAddress" placeholder="Enter your Binance wallet address" class="w-full">
                        <p class="text-xs text-gray-500 mt-2">Make sure the address is correct</p>
                    </div>
                    <button id="requestWithdrawBtn" class="btn btn-accent w-full mb-6 py-4 text-lg" disabled>
                        <i class="fas fa-paper-plane mr-2"></i> Request Withdrawal
                    </button>
                    <div>
                        <h3 class="font-bold text-lg mb-4 text-gray-800">Transaction History</h3>
                        <div id="withdrawalHistory" class="space-y-3">
                            <div class="text-center py-8 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-2"></i>
                                <p>No transactions yet</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bottom-nav">
            <div class="glass-card rounded-none border-0 shadow-none">
                <div class="flex">
                    <div class="tab-button active" data-tab="home">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </div>
                    <div class="tab-button" data-tab="tasks">
                        <i class="fas fa-tasks"></i>
                        <span>Tasks</span>
                    </div>
                    <div class="tab-button" data-tab="winners">
                        <i class="fas fa-trophy"></i>
                        <span>Winners</span>
                    </div>
                    <div class="tab-button" data-tab="withdraw">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="text-center mb-4">
                <div class="w-16 h-16 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">Success!</h3>
                <p id="confirmMessage" class="text-gray-600">Action completed successfully</p>
            </div>
            <button id="confirmBtn" class="btn btn-primary w-full">
                Got it!
            </button>
        </div>
    </div>

<script>
// === CONFIG ===
const VIRAL_LINKS = [
'https://www.effectivegatecpm.com/abxysby62i?key=4061879b22a9fa181066a0f2c57ae72d',
'https://www.effectivegatecpm.com/tqypp62y2w?key=74cc971fb77af7a1038cdccbafd2432f',
'https://www.effectivegatecpm.com/tutkw1sahh?key=272554dae7b213c13d92f046080861a2',
'https://www.effectivegatecpm.com/kfarq0tuw?key=e6a1cde9dcf8a5bf8f73fb24245c3de5',
'https://www.effectivegatecpm.com/ebpv48yuy?key=ec6b3137e555bdf5c6d2e3664ce83ed0',
'https://www.effectivegatecpm.com/suw0nq9i?key=466383182ed764e6be16b50776d8e8fc',
'https://www.effectivegatecpm.com/vrz22uepfw?key=298621cc890b0e61db6be8866a62bc88',
'https://otieu.com/4/9923541',
'https://otieu.com/4/9923538',
'https://www.effectivegatecpm.com/abxysby62i?key=4061879b22a9fa181066a0f2c57ae72d',
'https://www.effectivegatecpm.com/tqypp62y2w?key=74cc971fb77af7a1038cdccbafd2432f',
'https://www.effectivegatecpm.com/tutkw1sahh?key=272554dae7b213c13d92f046080861a2',
'https://www.effectivegatecpm.com/kfarq0tuw?key=e6a1cde9dcf8a5bf8f73fb24245c3de5',
'https://www.effectivegatecpm.com/ebpv48yuy?key=ec6b3137e555bdf5c6d2e3664ce83ed0',
'https://www.effectivegatecpm.com/suw0nq9i?key=466383182ed764e6be16b50776d8e8fc',
'https://www.effectivegatecpm.com/vrz22uepfw?key=298621cc890b0e61db6be8866a62bc88',
'https://otieu.com/4/9923540',
'https://otieu.com/4/9904808',
'https://otieu.com/4/9923537'
];

// Bangladeshi names for winner selection
const BANGLADESHI_NAMES = [
  'Nasir Khan', 'Fatima Begum', 'Mohammad Rahman', 'Ayesha Khan', 'Hasan Ahmed',
  'Nusrat Jahan', 'Kamal Hossain', 'Shamima Akter', 'Rafiqul Islam', 'Farzana Yasmin',
  'Jubayer Ahmed', 'Taslima Khatun', 'Mahmudul Hasan', 'Sabina Yeasmin', 'Shakil Ahmed',
  'Sumaiya Akter', 'Imran Hossain', 'Nadia Sultana', 'Saiful Islam', 'Mehnaz Parvin',
  'Arif Rahman', 'Rashida Begum', 'Nayeem Islam', 'Jannatul Ferdous', 'Sohel Rana',
  'Riya Akter', 'Tarek Ahmed', 'Nusrat Islam', 'Jashim Uddin', 'Shammi Akhter',
  'Mizanur Rahman', 'Mehedi Hasan', 'Nishat Jahan', 'Samiul Islam', 'Tasnuva Ahmed',
  'Riyad Hossain', 'Sanjida Akter', 'Fahim Islam', 'Sumaiya Sultana', 'Mehedi Hasan',
  'Nadia Islam', 'Rakibul Hasan', 'Jannatul Islam', 'Sabbir Ahmed', 'Mehjabin Akter',
  'Shakil Islam', 'Maliha Khatun', 'Mamunur Rashid', 'Farhana Islam', 'Sujon Mia',
  'Taslima Begum', 'Abu Bakar', 'Mst. Sultana', 'Riyad Islam', 'Jannatul Nayeem',
  'Sohag Ahmed', 'Mst. Akter', 'Rafiq Islam', 'Mst. Jahan', 'Sohel Mia',
  'Mst. Begum', 'Abdul Karim', 'Mst. Khatun', 'Mohammad Ali', 'Mst. Sultana',
  'Abdul Khalek', 'Mst. Akter', 'Mst. Begum', 'Abdul Latif', 'Mst. Jahan',
  'Abdul Matin', 'Mst. Khatun', 'Abdul Mannan', 'Mst. Begum', 'Abdul Momin',
  'Mst. Sultana', 'Abdul Muktadir', 'Mst. Akter', 'Abdul Quddus', 'Mst. Jahan',
  'Abdul Razzak', 'Mst. Khatun', 'Abdul Salam', 'Mst. Begum', 'Abdul Samad',
  'Mst. Sultana', 'Abdul Wahab', 'Mst. Akter', 'Abdul Wahid', 'Mst. Jahan',
  'Abdul Wadud', 'Mst. Khatun', 'Abdul Zabbar', 'Mst. Begum', 'Abdul Zahir',
  'Mst. Sultana', 'Abdul Zakir', 'Mst. Akter', 'Abdul Jalil', 'Mst. Jahan',
  'Abdul Karim', 'Mst. Khatun', 'Abdul Khalek', 'Mst. Begum', 'Abdul Latif',
  'Mst. Sultana', 'Abdul Matin', 'Mst. Akter', 'Abdul Mannan', 'Mst. Jahan',
  'Abdul Momin', 'Mst. Khatun', 'Abdul Muktadir', 'Mst. Begum', 'Abdul Quddus',
  'Mst. Sultana', 'Abdul Razzak', 'Mst. Akter', 'Abdul Salam', 'Mst. Jahan',
  'Abdul Samad', 'Mst. Khatun', 'Abdul Wahab', 'Mst. Begum', 'Abdul Wahid',
  'Mst. Sultana', 'Abdul Wadud', 'Mst. Akter', 'Abdul Zabbar', 'Mst. Jahan',
  'Abdul Zahir', 'Mst. Khatun', 'Abdul Zakir', 'Mst. Begum'
];

// === STATE ===
let appState = {
  userId: null,
  userName: 'Guest',
  userPic: '',
  adsWatched: 0,
  linksWatched: 0,
  isParticipating: false,
  balance: 0,
  clickedLinks: new Set(),
  currentCycleId: null,
  withdrawalHistory: [],
  adLoading: false,
  adAvailable: true,
  lastAdAttempt: 0,
  adRetryCount: 0,
  currentWinner: null,
  previousWinner: null
};

// === FIRESTORE HELPERS ===
// Get or create the current giveaway cycle
async function getOrCreateGiveawayCycle() {
  const now = new Date();
  const cycleId = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())).toISOString().split('T')[0];

  const docRef = db.collection('giveaways').doc(cycleId);
  const doc = await docRef.get();

  if (!doc.exists) {
    // Get previous cycle to move its winner to history
    const yesterday = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - 1));
    const yesterdayId = yesterday.toISOString().split('T')[0];
    const yesterdayDoc = await db.collection('giveaways').doc(yesterdayId).get();
    
    let previousWinners = [];
    let previousWinnerName = null;
    
    if (yesterdayDoc.exists) {
      const yesterdayData = yesterdayDoc.data();
      previousWinners = yesterdayData.previousWinners || [];
      // Add yesterday's winner to the beginning of the history
      if (yesterdayData.winner) {
        previousWinnerName = yesterdayData.winner;
        previousWinners.unshift({
          name: yesterdayData.winner,
          date: 'Yesterday',
          cycleId: yesterdayId
        });
        // Keep only the last winner
        previousWinners = previousWinners.slice(0, 1);
      }
    }

    // Select a random winner from Bangladeshi names
    const randomWinner = BANGLADESHI_NAMES[Math.floor(Math.random() * BANGLADESHI_NAMES.length)];

    // Initialize new cycle WITH a winner
    await docRef.set({
      cycleId,
      winner: randomWinner,
      winnerDate: 'Today',
      previousWinners: previousWinners,
      createdAt: firebase.firestore.Timestamp.fromDate(new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()))),
      endsAt: firebase.firestore.Timestamp.fromDate(new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() + 1))),
      winnerSelected: true,
      winnerSelectedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Set the current and previous winners in app state
    appState.currentWinner = randomWinner;
    appState.previousWinner = previousWinnerName;
  } else {
    // If the cycle exists, set the winners from the data
    const cycleData = doc.data();
    appState.currentWinner = cycleData.winner;
    appState.previousWinner = cycleData.previousWinners && cycleData.previousWinners.length > 0 
      ? cycleData.previousWinners[0].name 
      : null;
  }

  return { id: cycleId, ...doc.data() };
}

// Select winner when timer ends
async function selectWinner() {
  const now = new Date();
  const cycleId = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate())).toISOString().split('T')[0];
  
  const docRef = db.collection('giveaways').doc(cycleId);
  const doc = await docRef.get();
  
  if (doc.exists) {
    // Get current data to preserve previous winners
    const currentData = doc.data();
    let previousWinners = currentData.previousWinners || [];
    
    // Add today's winner to the beginning of the history
    previousWinners.unshift({
      name: currentData.winner,
      date: 'Yesterday',
      cycleId: cycleId
    });
    // Keep only the last winner
    previousWinners = previousWinners.slice(0, 1);
    
    // Select a new random winner from Bangladeshi names
    const newWinner = BANGLADESHI_NAMES[Math.floor(Math.random() * BANGLADESHI_NAMES.length)];
    
    // Update the document with the new winner and updated previous winners
    await docRef.update({
      winner: newWinner,
      winnerDate: 'Today',
      winnerSelected: true,
      winnerSelectedAt: firebase.firestore.FieldValue.serverTimestamp(),
      previousWinners: previousWinners
    });
    
    console.log('New winner selected:', newWinner);
    
    // Update the app state
    appState.previousWinner = appState.currentWinner;
    appState.currentWinner = newWinner;
    
    // Update the UI with animation
    updateWinnerWithAnimation(newWinner);
    
    // Add confetti effect
    createConfetti();
    
    return newWinner;
  }
  
  return doc.data()?.winner;
}

// Update winner with animation
function updateWinnerWithAnimation(winnerName) {
  const winnerElement = document.getElementById('currentWinner');
  const winnerCard = document.querySelector('.winner-card');
  
  // Add animation class
  winnerCard.classList.add('winner-updating');
  
  // Fade out
  winnerElement.style.opacity = '0.3';
  
  setTimeout(() => {
    // Update the winner name
    winnerElement.textContent = winnerName;
    
    // Fade in
    winnerElement.style.opacity = '1';
    
    // Remove animation class
    setTimeout(() => {
      winnerCard.classList.remove('winner-updating');
    }, 1000);
  }, 500);
}

// Add this new function to update just the previous winners display
function updatePreviousWinnersDisplay(previousWinners) {
  const colors = ['from-yellow-400 to-orange-500'];
  
  if (previousWinners.length === 0) {
    document.getElementById('previousWinner').innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <i class="fas fa-history text-4xl mb-2"></i>
        <p>No previous winner yet</p>
      </div>
    `;
  } else {
    const w = previousWinners[0];
    document.getElementById('previousWinner').innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-gradient-to-br ${colors[0]} rounded-full flex items-center justify-center mr-3">
            <i class="fas fa-medal text-white"></i>
          </div>
          <div>
            <p class="font-bold text-gray-800">${w.name}</p>
            <p class="text-xs text-gray-500">${w.date}</p>
          </div>
        </div>
        <span class="text-green-600 font-bold">$100</span>
      </div>
    `;
  }
}

// Load user state from Firestore
async function loadUserState(userId) {
  if (!userId) return null;
  try {
    const userDoc = await db.collection('users').doc(userId.toString()).get();
    return userDoc.exists ? userDoc.data() : null;
  } catch (error) {
    console.error('Error loading user state:', error);
    return null;
  }
}

// Save user state to Firestore
async function saveUserState() {
  if (!appState.userId) return;
  try {
    await db.collection('users').doc(appState.userId.toString()).set({
      adsWatched: appState.adsWatched,
      linksWatched: appState.linksWatched,
      isParticipating: appState.isParticipating,
      balance: appState.balance,
      withdrawalHistory: appState.withdrawalHistory,
      clickedLinks: Array.from(appState.clickedLinks),
      currentCycleId: appState.currentCycleId,
      lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
    
    // Also save to localStorage as backup
    localStorage.setItem('giveawayAppState', JSON.stringify({
      adsWatched: appState.adsWatched,
      linksWatched: appState.linksWatched,
      isParticipating: appState.isParticipating,
      balance: appState.balance,
      clickedLinks: Array.from(appState.clickedLinks),
      currentCycleId: appState.currentCycleId
    }));
    
    console.log('User state saved successfully');
  } catch (error) {
    console.error('Error saving user state:', error);
  }
}

// Load user state from localStorage as backup
function loadFromLocalStorage() {
  try {
    const saved = localStorage.getItem('giveawayAppState');
    if (saved) {
      const data = JSON.parse(saved);
      return data;
    }
  } catch (error) {
    console.error('Error loading from localStorage:', error);
  }
  return null;
}

// Reset user data when a new cycle starts
async function resetUserDataForNewCycle() {
  appState.adsWatched = 0;
  appState.linksWatched = 0;
  appState.isParticipating = false;
  appState.clickedLinks = new Set();
  await saveUserState();
  updateAdProgress();
  updateLinkProgress();
  updateEnterProgress();
  console.log('User data reset for new cycle');
}

// === TELEGRAM INIT ===
function initTelegramApp() {
  if (window.Telegram?.WebApp) {
    window.Telegram.WebApp.expand();
    window.Telegram.WebApp.enableClosingConfirmation();
    let user = window.Telegram.WebApp.initDataUnsafe?.user;
    if (!user && window.Telegram.WebApp.initData) {
      try {
        const params = new URLSearchParams(window.Telegram.WebApp.initData);
        const userStr = params.get('user');
        if (userStr) user = JSON.parse(decodeURIComponent(userStr));
      } catch (e) {
        console.error('Parse error:', e);
      }
    }
    if (user) {
      appState.userId = user.id;
      appState.userName = (user.first_name || '') + (user.last_name ? ' ' + user.last_name : '');
      appState.userPic = user.photo_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.id}`;
      document.getElementById('userName').textContent = appState.userName;
      document.getElementById('userProfilePic').src = appState.userPic;
    }
  } else {
    // Generate unique test user ID
    appState.userId = 'test_user_' + Math.random().toString(36).substr(2, 9);
    appState.userName = 'Test User';
  }
}

// === COUNTDOWN & WINNER LOGIC ===
let currentGiveawayCycle = null;
let countdownInterval = null;

function getNextCycleEndTimestamp() {
  return currentGiveawayCycle.endsAt.toMillis();
}

function updateCountdown() {
  const now = Date.now();
  const end = getNextCycleEndTimestamp();
  const distance = end - now;

  if (distance <= 0) {
    // Cycle ended - select winner and refresh
    clearInterval(countdownInterval);
    document.getElementById('homeCountdown').textContent = '0h 0m 0s';
    
    // Select winner before refreshing
    selectWinner().then(() => {
      refreshGiveawayCycle();
    });
    return;
  }

  const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((distance % (1000 * 60)) / 1000);
  document.getElementById('homeCountdown').textContent = `${hours}h ${minutes}m ${seconds}s`;
}

function startCountdown() {
  updateCountdown();
  countdownInterval = setInterval(updateCountdown, 1000);
}

// Refresh the giveaway cycle when timer ends
async function refreshGiveawayCycle() {
  // First check if we need to select a winner
  const now = Date.now();
  const end = getNextCycleEndTimestamp();
  
  if (now >= end) {
    // Time is up, select a winner
    await selectWinner();
    
    // Wait a moment to ensure the winner is saved
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Create a new cycle for tomorrow
    const tomorrow = new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate() + 1));
    const tomorrowId = tomorrow.toISOString().split('T')[0];
    const tomorrowDocRef = db.collection('giveaways').doc(tomorrowId);
    const tomorrowDoc = await tomorrowDocRef.get();
    
    if (!tomorrowDoc.exists) {
      // Get today's cycle data to move winner to history
      const todayId = new Date(Date.UTC(new Date().getUTCFullYear(), new Date().getUTCMonth(), new Date().getUTCDate())).toISOString().split('T')[0];
      const todayDoc = await db.collection('giveaways').doc(todayId).get();
      
      if (todayDoc.exists) {
        const todayData = todayDoc.data();
        let previousWinners = todayData.previousWinners || [];
        
        // Select a random winner from Bangladeshi names for tomorrow
        const randomWinner = BANGLADESHI_NAMES[Math.floor(Math.random() * BANGLADESHI_NAMES.length)];
        
        // Create new cycle for tomorrow with the updated previous winners and a winner
        await tomorrowDocRef.set({
          cycleId: tomorrowId,
          winner: randomWinner,
          winnerDate: 'Today',
          previousWinners: previousWinners,
          createdAt: firebase.firestore.Timestamp.fromDate(tomorrow),
          endsAt: firebase.firestore.Timestamp.fromDate(new Date(Date.UTC(tomorrow.getUTCFullYear(), tomorrow.getUTCMonth(), tomorrow.getUTCDate() + 1))),
          winnerSelected: true,
          winnerSelectedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update the current cycle to the new one
        currentGiveawayCycle = { id: tomorrowId, ...(await tomorrowDocRef.get()).data() };
        appState.currentCycleId = currentGiveawayCycle.id;
        
        // Update the app state with the new winner
        appState.previousWinner = appState.currentWinner;
        appState.currentWinner = randomWinner;
      }
    }
  } else {
    // Get the current cycle (which might be a new one)
    currentGiveawayCycle = await getOrCreateGiveawayCycle();
    appState.currentCycleId = currentGiveawayCycle.id;
  }
  
  // Check if user needs to be reset for new cycle
  if (appState.userId) {
    const userData = await loadUserState(appState.userId);
    if (!userData || userData.currentCycleId !== appState.currentCycleId) {
      await resetUserDataForNewCycle();
    }
  }
  
  updateWinnersDisplay(currentGiveawayCycle);
  startCountdown();
}

// === UI UPDATERS ===
function updateAdProgress() {
  const pct = (appState.adsWatched / 100) * 100;
  document.getElementById('adProgress').style.width = `${pct}%`;
  document.getElementById('adProgressText').textContent = `${appState.adsWatched}/100`;
  document.getElementById('adsWatchedCount').textContent = appState.adsWatched;
  
  const btn = document.getElementById('watchAdBtn');
  if (appState.adsWatched >= 100) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-check mr-2"></i> Completed';
  } else if (appState.adLoading) {
    btn.disabled = true;
    btn.innerHTML = '<span class="ad-loading"></span> Loading...';
  } else {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-play mr-2"></i> Watch Ad';
  }
}

function updateLinkProgress() {
  const total = VIRAL_LINKS.length;
  const pct = (appState.linksWatched / total) * 100;
  document.getElementById('linkProgress').style.width = `${pct}%`;
  document.getElementById('linkProgressText').textContent = `${appState.linksWatched}/${total}`;
  document.getElementById('linksWatchedCount').textContent = appState.linksWatched;
  document.getElementById('watchLinkBtn').innerHTML = `<i class="fas fa-external-link-alt mr-2"></i> Watch Link`;
}

function updateEnterProgress() {
  const total = 100 + VIRAL_LINKS.length;
  const completed = appState.adsWatched + appState.linksWatched;
  const pct = Math.round((completed / total) * 100);
  const fill = document.getElementById('enterProgressFill');
  const text = document.getElementById('enterProgressText');
  fill.style.width = `${pct}%`;

  if (completed >= total && !appState.isParticipating) {
    fill.classList.add('complete');
    text.innerHTML = '<i class="fas fa-rocket mr-2"></i> ðŸŽ‰ CLICK TO ENTER GIVEAWAY! ðŸŽ‰';
  } else if (appState.isParticipating) {
    fill.classList.add('complete');
    text.innerHTML = '<i class="fas fa-check-circle mr-2"></i> You\'re in the giveaway! Good luck!';
  } else {
    fill.classList.remove('complete');
    text.innerHTML = `<i class="fas fa-rocket mr-2"></i> Enter Giveaway (${completed}/${total})`;
  }
}

function updateWinnersDisplay(cycle) {
  // Always use the winner from the app state
  const winnerName = appState.currentWinner || 'Loading...';
  const winnerDate = cycle.winnerDate || 'Today';
  const winnerTitle = cycle.winner ? 'ðŸŽŠ Today\'s Winner ðŸŽŠ' : 'ðŸŽŠ Today\'s Winner ðŸŽŠ';
  
  document.getElementById('currentWinner').textContent = winnerName;
  document.getElementById('winnerDate').textContent = winnerDate;
  document.getElementById('winnerTitle').textContent = winnerTitle;

  // Use previous winners if they exist
  const prevWinners = cycle.previousWinners && cycle.previousWinners.length > 0 
    ? cycle.previousWinners 
    : [];
  
  updatePreviousWinnersDisplay(prevWinners);
}

function updateBalanceDisplay() {
  const bal = appState.balance.toFixed(2);
  document.getElementById('userBalance').textContent = bal;
  document.getElementById('withdrawBalance').textContent = bal;
  document.getElementById('requestWithdrawBtn').disabled = appState.balance < 10;
}

// === CONFETTI ===
function createConfetti() {
  const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#fa709a', '#fee140'];
  for (let i = 0; i < 100; i++) {
    setTimeout(() => {
      const c = document.createElement('div');
      c.className = 'confetti';
      c.style.left = Math.random() * 100 + '%';
      c.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 3000);
    }, i * 30);
  }
}

function showConfirmModal(msg, cb) {
  document.getElementById('confirmMessage').textContent = msg;
  const modal = document.getElementById('confirmModal');
  modal.classList.add('show');
  document.getElementById('confirmBtn').onclick = () => {
    modal.classList.remove('show');
    cb();
  };
}

// === AD & LINK HANDLERS ===
function showAd() {
  if (appState.adsWatched >= 100 || appState.adLoading) return;
  
  const btn = document.getElementById('watchAdBtn');
  const statusEl = document.getElementById('adStatus');
  const errorEl = document.getElementById('adError');
  
  // Clear previous status messages
  statusEl.textContent = '';
  errorEl.textContent = '';
  
  appState.adLoading = true;
  updateAdProgress();
  
  // Check if ad function is available
  if (typeof show_10019074 !== 'function') {
    errorEl.textContent = 'Ad script not loaded. Please refresh the page.';
    appState.adLoading = false;
    updateAdProgress();
    return;
  }
  
  // Try to show ad
  statusEl.textContent = 'Loading ad...';
  
  try {
    console.log(`Attempting to show ad from zone 10019074`);
    
    show_10019074().then(() => {
      // User has successfully watched the ad
      appState.adsWatched++;
      appState.adRetryCount = 0; // Reset retry count on success
      statusEl.textContent = 'Ad completed successfully!';
      updateAdProgress();
      updateEnterProgress();
      saveUserState();
      
      // Clear status message after 2 seconds
      setTimeout(() => {
        statusEl.textContent = '';
      }, 2000);
      
      appState.adLoading = false;
      updateAdProgress();
    }).catch((error) => {
      console.error('Ad failed to load:', error);
      handleAdError('No ads available at the moment. Please try again later.');
    });
  } catch (error) {
    console.error('Error showing ad:', error);
    handleAdError('Error loading ad. Please try again.');
  }
  
  function handleAdError(message) {
    errorEl.textContent = message;
    statusEl.textContent = '';
    appState.adRetryCount++;
    
    // If we've tried multiple times, suggest waiting
    if (appState.adRetryCount > 2) {
      errorEl.textContent = 'Ads are temporarily unavailable. Please try again in a few minutes.';
      appState.adAvailable = false;
      
      // Reset availability after 5 minutes
      setTimeout(() => {
        appState.adAvailable = true;
        appState.adRetryCount = 0;
      }, 5 * 60 * 1000);
    }
    
    appState.adLoading = false;
    updateAdProgress();
  }
}

function watchLink() {
  if (appState.linksWatched >= VIRAL_LINKS.length) return;
  let idx = -1;
  for (let i = 0; i < VIRAL_LINKS.length; i++) {
    if (!appState.clickedLinks.has(i)) { idx = i; break; }
  }
  if (idx === -1) return;

  appState.clickedLinks.add(idx);
  appState.linksWatched++;
  window.open(VIRAL_LINKS[idx], '_blank');

  updateLinkProgress();
  updateEnterProgress();
  saveUserState();
}

// === EVENT LISTENERS SETUP ===
function setupEventListeners() {
  document.getElementById('watchAdBtn').addEventListener('click', showAd);
  document.getElementById('watchLinkBtn').addEventListener('click', watchLink);

  document.getElementById('enterProgress').addEventListener('click', () => {
    const total = 100 + VIRAL_LINKS.length;
    const completed = appState.adsWatched + appState.linksWatched;
    if (completed >= total && !appState.isParticipating) {
      showConfirmModal("ðŸŽŠ You're in the $100 Giveaway! Good luck!", () => {
        appState.isParticipating = true;
        saveUserState();
        createConfetti();
        updateEnterProgress();
      });
    }
  });

  // Withdrawal logic
  document.getElementById('requestWithdrawBtn').addEventListener('click', () => {
    const addr = document.getElementById('binanceAddress').value.trim();
    if (!addr) return;
    if (appState.balance < 10) return;
    appState.withdrawalHistory.unshift({
      id: Date.now(),
      amount: appState.balance,
      address: addr,
      date: new Date().toLocaleDateString(),
      status: 'pending'
    });
    appState.balance = 0;
    saveUserState();
    updateBalanceDisplay();
    document.getElementById('binanceAddress').value = '';
  });

  // Tabs
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
      document.querySelector('.container').scrollTop = 0;
    });
  });
}

// === MAIN INIT ===
async function initApp() {
  try {
    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Initialize Telegram
    initTelegramApp();

    // Get current giveaway cycle
    currentGiveawayCycle = await getOrCreateGiveawayCycle();
    appState.currentCycleId = currentGiveawayCycle.id;

    // Load user data with improved logic
    if (appState.userId) {
      // First try to load from Firestore
      const userData = await loadUserState(appState.userId);
      
      if (userData && userData.currentCycleId === appState.currentCycleId) {
        // Load existing user data from Firestore
        appState.adsWatched = userData.adsWatched || 0;
        appState.linksWatched = userData.linksWatched || 0;
        appState.isParticipating = userData.isParticipating || false;
        appState.balance = userData.balance || 0;
        appState.withdrawalHistory = userData.withdrawalHistory || [];
        appState.clickedLinks = new Set(userData.clickedLinks || []);
        
        console.log("User data loaded from Firestore successfully");
      } else {
        // Try to load from localStorage as backup
        const localData = loadFromLocalStorage();
        if (localData && localData.currentCycleId === appState.currentCycleId) {
          appState.adsWatched = localData.adsWatched || 0;
          appState.linksWatched = localData.linksWatched || 0;
          appState.isParticipating = localData.isParticipating || false;
          appState.balance = localData.balance || 0;
          appState.clickedLinks = new Set(localData.clickedLinks || []);
          
          // Save to Firestore for persistence
          saveUserState();
          console.log("User data loaded from localStorage and saved to Firestore");
        } else {
          // New cycle or new user
          await resetUserDataForNewCycle();
          console.log("User data reset for new cycle");
        }
      }
    }

    // Update UI
    updateAdProgress();
    updateLinkProgress();
    updateEnterProgress();
    updateBalanceDisplay();
    updateWinnersDisplay(currentGiveawayCycle);

    // Setup event listeners
    setupEventListeners();

    // Start countdown
    startCountdown();

    // Hide loading overlay
    document.getElementById('loadingOverlay').style.display = 'none';

  } catch (error) {
    console.error("Initialization error:", error);
    document.getElementById('loadingOverlay').style.display = 'none';
  }
}

// Start the app when DOM is loaded
document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
